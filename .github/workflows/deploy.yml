name: Deploy Infraestrutura Foundational

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  TF_VERSION: '1.5.0'
  ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
  ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

jobs:
  terraform:
    name: 'Terraform Plan & Apply'
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout do c√≥digo
      - name: 'Checkout code'
        uses: actions/checkout@v4

      # 2. Login no Azure
      - name: 'Azure Login'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Setup do Terraform
      - name: 'Setup Terraform'
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}

      # 4. Terraform Format Check  
      - name: 'Terraform Format Check'
        run: |
          echo "üîç Checking Terraform formatting..."
          terraform fmt -check -recursive
        continue-on-error: true

      # 5. Terraform Init
      - name: 'Terraform Init'
        run: |
          echo "üîß Initializing Terraform..."
          terraform init
          echo "‚úÖ Terraform initialized!"

      # 6. Terraform Validate
      - name: 'Terraform Validate'
        run: |
          echo "‚úÖ Validating Terraform configuration..."
          terraform validate
          echo "‚úÖ Configuration is valid!"

      # 7. Terraform Plan
      - name: 'Terraform Plan'
        run: |
          echo "üìã Planning infrastructure changes..."
          terraform plan -out=tfplan
          echo "‚úÖ Plan complete!"

      # 8. Terraform Apply (s√≥ na main e push)
      - name: 'Terraform Apply'
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "üöÄ Applying infrastructure changes..."
          terraform apply -auto-approve tfplan
          echo "‚úÖ Infrastructure deployed successfully!"

      # 9. Terraform Output (mostra outputs importantes)
      - name: 'Show Terraform Outputs'
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "üìä Infrastructure Outputs:"
          terraform output -json

      # 10. Logout do Azure
      - name: 'Azure Logout'
        if: always()
        run: |
          az logout
          echo "‚úÖ Logged out from Azure"